<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Mini OpenStax: Student Dashboard ‚Äî Track your phonics mastery" />
  <title>Mini OpenStax ‚Äî Dashboard</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --red: #ce1126;
      --light: #f9f9f9;
      --dark: #2d2d2d;
      --card-bg: #ffffff;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--light);
      color: var(--dark);
      line-height: 1.5;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .greeting {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--green);
    }

    .progress-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1.2rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 1.25rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: var(--shadow);
      border-top: 3px solid var(--green);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--green);
      margin: 0.25rem 0;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    .section-title {
      font-size: 1.4rem;
      margin: 1.5rem 0 1rem;
      color: var(--dark);
    }

    .lesson-grid {
      display: grid;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .lesson-card {
      background: var(--card-bg);
      padding: 1.25rem;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lesson-info h3 {
      margin: 0 0 0.25rem;
      font-size: 1.1rem;
    }

    .lesson-info .status {
      font-size: 0.85rem;
      color: #777;
    }

    .status-mastered { color: var(--green); font-weight: bold; }
    .status-incomplete { color: #888; }

    .btn {
      display: inline-block;
      background: var(--green);
      color: white;
      font-weight: 700;
      padding: 0.75rem 16px;
      border-radius: 50px;
      text-decoration: none;
      font-size: 1.05rem;
      letter-spacing: 0.5px;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
      text-align: center;
    }

    .btn:hover, .btn:focus {
      opacity: 0.92;
      outline: 2px solid currentColor;
      outline-offset: 4px;
    }

    .btn-secondary {
      background: var(--gold);
      color: var(--dark);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--green);
      color: var(--green);
    }

    .btn-whatsapp {
      background: #25D366;
      color: white;
    }

    .footer {
      text-align: center;
      padding: 1.5rem 0 1rem;
      color: #777;
      font-size: 0.9rem;
      border-top: 1px solid #eee;
      margin-top: 1rem;
    }

    /* === REPORTS PANEL === */
    #reports-panel {
      display: none;
      margin-top: 2rem;
      padding: 1.5rem;
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 10px;
    }

    .search-box {
      margin: 1rem 0;
      text-align: center;
    }

    #student-search {
      padding: 8px 12px;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    #search-btn {
      padding: 8px 16px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 4px;
      margin-left: 10px;
      cursor: pointer;
    }

    #search-btn:hover {
      background: #0056b3;
    }

    .note {
      text-align: center;
      color: #6c757d;
      font-size: 0.875rem;
      margin: 10px 0 1.5rem;
    }

    .report-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.4;
      overflow-x: auto;
    }

    .report-date {
      margin-top: 8px;
      font-style: italic;
      color: #6c757d;
      font-family: Arial, sans-serif;
      font-size: 12px;
    }

    .report-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 4px 8px;
      font-size: 12px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .action-btn:hover {
      background: #5a6268;
    }

    .error {
      text-align: center;
      color: #dc3545;
      padding: 20px;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      .header, .lesson-card, .panel-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
      .lesson-card { align-items: stretch; }
      #student-search { width: 100%; margin-bottom: 10px; }
      #search-btn, #whatsapp-all { margin-left: 0; width: 100%; }
      .panel-header > * { width: 100%; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="greeting" id="greeting">Hello, [Name]</div>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
        <a href="../index.html" class="btn btn-secondary">‚Üê Home</a>
        <button id="toggle-reports" class="btn btn-outline">üìä View All Reports</button>
      </div>
    </div>

    <div class="progress-grid">
      <div class="stat-card">
        <div class="stat-value" id="lessons-attempted">0</div>
        <div class="stat-label">Lessons Attempted</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="lessons-mastered">0</div>
        <div class="stat-label">Mastered</div>
      </div>
    </div>

    <h2 class="section-title">Continue Learning</h2>
    <div class="lesson-grid" id="lesson-list">
      <!-- Populated by JS -->
    </div>

    <!-- REPORTS PANEL -->
    <div id="reports-panel">
      <div class="panel-header">
        <h2>All Quiz Reports (Lessons 2‚Äì262)</h2>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
          <button id="whatsapp-all" class="btn btn-whatsapp">üì§ Send All via WhatsApp</button>
          <button id="close-reports" class="btn btn-outline">‚úï Close</button>
        </div>
      </div>
      <div class="search-box">
        <input type="text" id="student-search" placeholder="Enter student name or leave blank for all" />
        <button id="search-btn">Search Reports</button>
      </div>
      <div class="note">Reports are saved only in this browser and tied to your quiz attempts.</div>
      <div id="results"></div>
    </div>

    <div class="footer">
      <p><a href="premium.html" style="color:var(--gold);">‚ú® Unlock Premium</a> ‚Ä¢ 
         <a href="instructor/analytics-1.html" style="color:#666;">üìä Instructor View</a></p>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const MAX_CHAPTER = 261;
    const STUDENT_NAME = localStorage.getItem('student_name') || 'Friend';
    const WHATSAPP_NUMBER = "233257320201";
    const REGISTRATION_LINE = "\n\nCALL OR WHATSAPP TO REGISTER FOR A CLASS @ +233257320201 / +233205626264";

    // ===== DASHBOARD INIT =====
    document.getElementById('greeting').textContent = `Hello, ${STUDENT_NAME}!`;

    let attempted = 0, mastered = 0;
    for (let i = 0; i <= MAX_CHAPTER; i++) {
      if (localStorage.getItem(`quiz_attempts_${i}`)) attempted++;
      if (localStorage.getItem(`mastery_${i}`) === '1') mastered++;
    }
    document.getElementById('lessons-attempted').textContent = attempted;
    document.getElementById('lessons-mastered').textContent = mastered;

    // Find next lesson to show
    let startChapter = 0;
    for (let i = 0; i <= Math.min(10, MAX_CHAPTER); i++) {
      if (localStorage.getItem(`mastery_${i}`) !== '1') {
        startChapter = i;
        break;
      }
    }

    const lessonList = document.getElementById('lesson-list');
    let rendered = 0;
    for (let i = startChapter; i <= MAX_CHAPTER && rendered < 4; i++) {
      const lessonNum = i + 1;
      const isMastered = localStorage.getItem(`mastery_${i}`) === '1';
      const attempts = localStorage.getItem(`quiz_attempts_${i}`);
      const statusText = isMastered ? '‚úÖ Mastered' : attempts ? 'üîÑ In Progress' : 'Not Started';
      const statusClass = isMastered ? 'status-mastered' : 'status-incomplete';

      const card = document.createElement('div');
      card.className = 'lesson-card';
      card.innerHTML = `
        <div class="lesson-info">
          <h3>Lesson ${lessonNum}: Short Vowel ${getVowel(i)}</h3>
          <div class="status ${statusClass}">${statusText}</div>
        </div>
        <a href="chapter-${i}.html" class="btn">Open</a>
      `;
      lessonList.appendChild(card);
      rendered++;
    }

    function getVowel(chapterIndex) {
      const vowels = ['a', 'e', 'i', 'o', 'u'];
      return vowels[chapterIndex % 5];
    }

    // ===== REPORTS SYSTEM =====
    (function() {
      const originalSetItem = localStorage.setItem;
      localStorage.setItem = function(key, value) {
        if (typeof value === 'string' && value.includes('*Mini OpenStax ‚Äî') && value.includes('Student:')) {
          const lessonMatch = value.match(/Lesson (\d+)/);
          if (lessonMatch) {
            const lessonNum = parseInt(lessonMatch[1], 10);
            if (lessonNum >= 2 && lessonNum <= 262) {
              const chapter = lessonNum - 1;
              const reportKey = `saved_report_${chapter}_${Date.now()}`;
              originalSetItem.call(localStorage, reportKey, value);
            }
          }
        }
        return originalSetItem.apply(this, arguments);
      };
    })();

    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown date';
      return new Date(timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function getFilteredReports(searchTerm = '') {
      const allKeys = Object.keys(localStorage);
      const reportEntries = [];
      for (const key of allKeys) {
        if (key.startsWith('saved_report_')) {
          const reportText = localStorage.getItem(key);
          if (reportText && typeof reportText === 'string') {
            const studentMatch = reportText.match(/Student:\s*(.+)\n/);
            const studentName = studentMatch ? studentMatch[1].trim() : '[Unknown]';
            if (!searchTerm || studentName.toLowerCase().includes(searchTerm.toLowerCase())) {
              const parts = key.split('_');
              const timestamp = parts.length >= 4 ? parseInt(parts[parts.length - 1], 10) : 0;
              reportEntries.push({ text: reportText, time: timestamp });
            }
          }
        }
      }
      return reportEntries.sort((a, b) => b.time - a.time);
    }

    function renderReportCard(reportText, timestamp) {
      const fullReportText = reportText + REGISTRATION_LINE;
      const safeHTML = fullReportText
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>');

      const card = document.createElement('div');
      card.className = 'report-card';
      card.innerHTML = `
        <div>${safeHTML}</div>
        <div class="report-date">Report Date: ${formatDate(timestamp)}</div>
        <div class="report-actions">
          <button class="action-btn download-svg">Download SVG</button>
          <button class="action-btn download-png">Download PNG</button>
          <button class="action-btn share-svg">Share SVG</button>
          <button class="action-btn share-png">Share PNG</button>
        </div>
      `;

      // === EXPORT LOGIC ===
      const studentMatch = reportText.match(/Student:\s*(.+)\n/);
      const lessonMatch = reportText.match(/Lesson (\d+)/);
      const studentName = (studentMatch ? studentMatch[1].trim() : 'Student').replace(/[^a-z0-9]/gi, '_');
      const lessonNum = lessonMatch ? lessonMatch[1] : 'X';
      const dateStr = new Date(timestamp).toISOString().slice(0, 10);
      const baseName = `QuizReport_Lesson${lessonNum}_${studentName}_${dateStr}`;

      // Helper: download blob
      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Helper: share or download
      async function shareOrDownload(blob, filename, title = 'Quiz Report') {
        if (navigator.share && navigator.canShare) {
          const file = new File([blob], filename, { type: blob.type });
          if (navigator.canShare({ files: [file] })) {
            try { await navigator.share({ title, files: [file] }); return; }
            catch (err) { if (err.name !== 'AbortError') console.warn('Share failed:', err); }
          }
        }
        downloadBlob(blob, filename);
      }

      // Generate SVG
      function generateSVG(text, width = 800, lineHeight = 16, padding = 20) {
        const lines = text.split('\n');
        const height = lines.length * lineHeight + padding * 2;
        const escapedLines = lines.map(line =>
          line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        );
        const tspans = escapedLines.map((line, i) => 
          `<tspan x="${padding}" dy="${i === 0 ? lineHeight : lineHeight}">${line}</tspan>`
        ).join('');
        return `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
  <style>.report-text { font-family: monospace; font-size: 13px; }</style>
  <rect width="100%" height="100%" fill="white" stroke="#ccc"/>
  <text x="0" y="${padding}" class="report-text">${tspans}</text>
</svg>`;
      }

      // SVG ‚Üí PNG
      function svgToPngBlob(svgString) {
        return new Promise((resolve, reject) => {
          const svgBlob = new Blob([svgString], { type: 'image/svg+xml' });
          const url = URL.createObjectURL(svgBlob);
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            URL.revokeObjectURL(url);
            canvas.toBlob(blob => blob ? resolve(blob) : reject(), 'image/png');
          };
          img.onerror = () => { URL.revokeObjectURL(url); reject(); };
          img.src = url;
        });
      }

      // Button handlers
      card.querySelector('.download-svg').onclick = () => {
        const blob = new Blob([generateSVG(fullReportText)], { type: 'image/svg+xml' });
        downloadBlob(blob, `${baseName}.svg`);
      };

      card.querySelector('.download-png').onclick = async () => {
        try {
          const png = await svgToPngBlob(generateSVG(fullReportText));
          downloadBlob(png, `${baseName}.png`);
        } catch (e) { alert('PNG export failed'); }
      };

      card.querySelector('.share-svg').onclick = () => {
        const blob = new Blob([generateSVG(fullReportText)], { type: 'image/svg+xml' });
        shareOrDownload(blob, `${baseName}.svg`, 'Quiz Report (SVG)');
      };

      card.querySelector('.share-png').onclick = async () => {
        try {
          const png = await svgToPngBlob(generateSVG(fullReportText));
          shareOrDownload(png, `${baseName}.png`, 'Quiz Report (PNG)');
        } catch (e) { alert('Share failed'); }
      };

      return card;
    }

    function showReports() {
      const searchTerm = document.getElementById('student-search').value.trim();
      const reports = getFilteredReports(searchTerm);
      const container = document.getElementById('results');

      if (reports.length === 0) {
        container.innerHTML = `<div class="error">No quiz reports found${searchTerm ? ` for "${searchTerm}"` : ''}.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();
      const heading = document.createElement('h3');
      heading.textContent = `${reports.length} Report(s) Found`;
      frag.appendChild(heading);

      reports.forEach(entry => frag.appendChild(renderReportCard(entry.text, entry.time)));
      container.innerHTML = '';
      container.appendChild(frag);
    }

    // ‚úÖ WHATSAPP BATCH SEND
    function sendAllReportsViaWhatsApp() {
      const searchTerm = document.getElementById('student-search').value.trim();
      const reports = getFilteredReports(searchTerm);
      if (reports.length === 0) return alert("No reports to send.");

      let msg = `*üìö Mini OpenStax ‚Äî All Quiz Reports*\nStudent: ${STUDENT_NAME}\nFiltered: ${searchTerm || 'All'}\nTotal: ${reports.length} report(s)\n\n---\n`;
      reports.forEach(r => msg += `\n${r.text}\n---\n`);
      msg += REGISTRATION_LINE;

      // Truncate to stay under WhatsApp limit (~4k chars)
      if (msg.length > 3800) msg = msg.substring(0, 3800) + "\n\n... (truncated)";

      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // ===== EVENT LISTENERS =====
    document.getElementById('toggle-reports').addEventListener('click', () => {
      document.getElementById('reports-panel').style.display = 'block';
      showReports();
    });

    document.getElementById('close-reports').addEventListener('click', () => {
      document.getElementById('reports-panel').style.display = 'none';
    });

    document.getElementById('search-btn').addEventListener('click', showReports);
    document.getElementById('student-search').addEventListener('keypress', e => {
      if (e.key === 'Enter') showReports();
    });

    document.getElementById('whatsapp-all').addEventListener('click', sendAllReportsViaWhatsApp);
  </script>
</body>
</html>
