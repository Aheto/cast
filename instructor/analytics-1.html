<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Analytics</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .chapter-nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 15px 0;
    }
    .chapter-btn {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
    }
    .chapter-btn.active, .chapter-btn:hover {
      background: #0056b3;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .search-container {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      justify-content: center;
    }
    #student-search {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
    }
    #search-btn {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    #search-btn:hover {
      background: #0056b3;
    }
    .results-container {
      display: none;
    }
    .section {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .section h2 {
      color: #007bff;
      margin-bottom: 15px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #28a745;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    .quiz-list {
      list-style: none;
      padding: 0;
    }
    .quiz-item {
      background: #f8f9fa;
      margin-bottom: 10px;
      padding: 12px;
      border-radius: 6px;
    }
    .quiz-header {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .quiz-details {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    .mastery-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }
    .mastery-pass {
      background: #28a745;
    }
    .mastery-fail {
      background: #dc3545;
    }
    .names-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .name-tag {
      background: #e9ecef;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 14px;
    }
    .error {
      color: #dc3545;
      text-align: center;
      padding: 20px;
      font-weight: bold;
    }
    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .lesson-item {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
    }
    .lesson-mastered {
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }
    @media (max-width: 600px) {
      .search-container {
        flex-direction: column;
        align-items: center;
      }
      #student-search {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Student Performance Analytics</h1>
      <div class="role-badge" style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
        Instructor View
      </div>
    </div>
    
    <!-- 5-button navigation system -->
    <nav class="chapter-nav">
      <a href="../index.html" class="chapter-btn">Home</a>
      <a href="analytics-1.html" class="chapter-btn active">Analytics</a>
      <a href="analytics-2.html" class="chapter-btn">Progress</a>
      <a href="analytics-3.html" class="chapter-btn">Reports</a>
      <a href="analytics-4.html" class="chapter-btn">Settings</a>
    </nav>
    
    <div class="search-container">
      <input type="text" id="student-search" placeholder="Enter student name...">
      <button id="search-btn">Search</button>
    </div>
    
    <div id="results" class="results-container">
      <!-- Results will be populated here -->
    </div>
  </div>

  <script>
    document.getElementById('search-btn').addEventListener('click', searchStudent);
    document.getElementById('student-search').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchStudent();
    });

    function searchStudent() {
      const searchTerm = document.getElementById('student-search').value.trim();
      if (!searchTerm) {
        alert('Please enter a student name');
        return;
      }

      // Get all localStorage keys
      const allKeys = Object.keys(localStorage);
      const studentData = {
        names: new Set(),
        quizzes: []
      };

      // Collect all names that match the search term
      for (const key of allKeys) {
        // Check for student_name entries
        if (key === 'student_name') {
          const name = localStorage.getItem(key);
          if (name && matchesSearch(name, searchTerm)) {
            studentData.names.add(name);
          }
        }
        // Check names in report data
        if (key.startsWith('quiz_report_')) {
          try {
            const report = JSON.parse(localStorage.getItem(key));
            if (report.student && matchesSearch(report.student, searchTerm)) {
              studentData.names.add(report.student);
            }
          } catch (e) {
            // Skip invalid JSON
          }
        }
      }

      // If still no names, check current student_name
      if (studentData.names.size === 0) {
        const currentName = localStorage.getItem('student_name');
        if (currentName && matchesSearch(currentName, searchTerm)) {
          studentData.names.add(currentName);
        }
      }

      if (studentData.names.size === 0) {
        showResults(null, 'No student found with that name');
        return;
      }

      // Now fetch data for ALL chapters (0 to 260 = Lessons 1 to 261)
      // But note: Lessons 2-262 correspond to chapters 1-261 (chapter-N.html = Lesson N+1)
      // So we process chapters 1 through 261 (which is index 1 to 261)
      for (let chapter = 1; chapter <= 261; chapter++) {
        const masteryKey = `mastery_${chapter}`;
        const attemptsKey = `quiz_attempts_${chapter}`;
        const reportKey = `quiz_report_${chapter}`;

        const mastery = localStorage.getItem(masteryKey) === '1';
        const attempts = parseInt(localStorage.getItem(attemptsKey)) || 0;
        let quizData = null;

        if (localStorage.getItem(reportKey)) {
          try {
            quizData = JSON.parse(localStorage.getItem(reportKey));
          } catch (e) {
            // Use basic data if parsing fails
          }
        }

        // Only include if student name matches OR if we have report data with matching name
        let includeQuiz = false;
        if (quizData && quizData.student) {
          includeQuiz = Array.from(studentData.names).some(name => 
            matchesSearch(quizData.student, name)
          );
        } else {
          // If no report, include if any name matches current student set
          includeQuiz = studentData.names.size > 0;
        }

        if (includeQuiz || (studentData.names.size > 0 && attempts > 0)) {
          studentData.quizzes.push({
            chapter,
            mastery,
            attempts,
            date: quizData?.date || null,
            timeSpent: quizData?.timeSpent || null,
            score: quizData?.score !== undefined ? quizData.score : null,
            total: quizData?.total || 20
          });
        }
      }

      displayResults(studentData);
    }

    function matchesSearch(name, searchTerm) {
      return name.toLowerCase().includes(searchTerm.toLowerCase());
    }

    function displayResults(data) {
      const quizzes = data.quizzes;
      const totalQuizzes = quizzes.length;
      let totalCorrect = 0;
      let totalWrong = 0;
      let totalTimeSpent = 0;
      const marks = [];
      const days = new Set();
      const attemptsPerQuiz = {};
      let masteredCount = 0;

      quizzes.forEach(quiz => {
        if (quiz.score !== null) {
          totalCorrect += quiz.score;
          totalWrong += (quiz.total - quiz.score);
          marks.push(quiz.score);
        }
        if (quiz.timeSpent) {
          totalTimeSpent += quiz.timeSpent;
        }
        if (quiz.date) {
          days.add(new Date(quiz.date).toDateString());
        }
        attemptsPerQuiz[quiz.chapter] = quiz.attempts;
        if (quiz.mastery) masteredCount++;
      });

      const averageMark = marks.length > 0 ? (totalCorrect / marks.length).toFixed(1) : 0;
      const highestMark = marks.length > 0 ? Math.max(...marks) : 0;
      const lowestMark = marks.length > 0 ? Math.min(...marks) : 0;

      // Find repeated marks
      const markCount = {};
      marks.forEach(mark => {
        markCount[mark] = (markCount[mark] || 0) + 1;
      });
      const repeatedMarks = Object.entries(markCount)
        .filter(([mark, count]) => count > 1)
        .map(([mark, count]) => `${mark} (${count} times)`);

      // Build lesson completion grid
      const lessonGrid = [];
      for (let i = 1; i <= 261; i++) {
        const quiz = quizzes.find(q => q.chapter === i);
        const isMastered = quiz ? quiz.mastery : false;
        const attempts = quiz ? quiz.attempts : 0;
        const lessonNum = i + 1; // Lesson = chapter + 1
        
        lessonGrid.push(`
          <div class="lesson-item ${isMastered ? 'lesson-mastered' : ''}" 
               title="Lesson ${lessonNum}: ${attempts} attempts${isMastered ? ' - Mastered' : ''}">
            L${lessonNum}
          </div>
        `);
      }

      const namesList = Array.from(data.names).map(name => 
        `<span class="name-tag">${name}</span>`
      ).join('');

      const quizList = quizzes.map(quiz => {
        const dateStr = quiz.date ? new Date(quiz.date).toLocaleDateString() : 'Unknown date';
        const timeStr = quiz.timeSpent ? `${quiz.timeSpent}s` : 'Unknown time';
        const masteryClass = quiz.mastery ? 'mastery-pass' : 'mastery-fail';
        const masteryText = quiz.mastery ? 'Mastered' : 'Needs Review';
        const scoreStr = quiz.score !== null ? `${quiz.score}/${quiz.total}` : 'Not recorded';
        const lessonNum = parseInt(quiz.chapter) + 1;

        return `
          <div class="quiz-item">
            <div class="quiz-header">
              <span>Lesson ${lessonNum} (chapter-${quiz.chapter}.html)</span>
              <span class="mastery-badge ${masteryClass}">${masteryText}</span>
            </div>
            <div class="quiz-details">
              <div>Date: ${dateStr}</div>
              <div>Time: ${timeStr}</div>
              <div>Attempts: ${quiz.attempts}</div>
              <div>Score: ${scoreStr}</div>
            </div>
          </div>
        `;
      }).join('');

      const resultsHTML = `
        <div class="section">
          <h2>Student Information</h2>
          <div class="names-list">${namesList}</div>
        </div>
        
        <div class="section">
          <h2>Performance Summary</h2>
          <div class="grid">
            <div class="stat-card">
              <div class="stat-value">${totalQuizzes}</div>
              <div class="stat-label">Quizzes Taken</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${masteredCount}</div>
              <div class="stat-label">Lessons Mastered</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${totalCorrect}</div>
              <div class="stat-label">Total Correct</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${totalWrong}</div>
              <div class="stat-label">Total Wrong</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${days.size}</div>
              <div class="stat-label">Active Days</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${Math.round(totalTimeSpent / 60)}m</div>
              <div class="stat-label">Total Time (min)</div>
            </div>
          </div>
        </div>
        
        <div class="section">
          <h2>Lesson Completion Overview (Lessons 2-262)</h2>
          <div class="lesson-grid">
            ${lessonGrid.join('')}
          </div>
        </div>
        
        <div class="section">
          <h2>Quiz Details</h2>
          ${quizList || '<p>No quiz records found</p>'}
        </div>
        
        <div class="section">
          <h2>Marks Analysis</h2>
          <div class="grid">
            <div class="stat-card">
              <div class="stat-value">${averageMark}</div>
              <div class="stat-label">Average Mark</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${highestMark}</div>
              <div class="stat-label">Highest Mark</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${lowestMark}</div>
              <div class="stat-label">Lowest Mark</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${repeatedMarks.length}</div>
              <div class="stat-label">Repeated Marks</div>
            </div>
          </div>
          ${repeatedMarks.length > 0 ? 
            `<div style="margin-top: 15px;">
              <strong>Repeated Marks:</strong> ${repeatedMarks.join(', ')}
            </div>` : ''}
        </div>
        
        <div class="section">
          <h2>Attempts per Quiz</h2>
          <div class="grid">
            ${Object.entries(attemptsPerQuiz).map(([lesson, attempts]) => {
              const lessonNum = parseInt(lesson) + 1;
              return `
                <div class="stat-card">
                  <div class="stat-value">${attempts}</div>
                  <div class="stat-label">Lesson ${lessonNum}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      showResults(resultsHTML);
    }

    function showResults(html, error = null) {
      const resultsContainer = document.getElementById('results');
      if (error) {
        resultsContainer.innerHTML = `<div class="error">${error}</div>`;
      } else {
        resultsContainer.innerHTML = html;
      }
      resultsContainer.style.display = 'block';
    }
  </script>
</body>
  </html>      const quizList = quizzes.map(quiz => {
        const dateStr = quiz.date ? new Date(quiz.date).toLocaleDateString() : 'Unknown date';
        const timeStr = quiz.timeSpent ? `${quiz.timeSpent}s` : 'Unknown time';
        const masteryClass = quiz.mastery ? 'mastery-pass' : 'mastery-fail';
        const masteryText = quiz.mastery ? 'Mastered' : 'Needs Review';
        const scoreStr = quiz.score !== null ? `${quiz.score}/${quiz.total}` : 'Not recorded';
        
        return `
          <div class="quiz-item">
            <div class="quiz-header">
              <span>Lesson ${parseInt(quiz.chapter) + 1}</span>
              <span class="mastery-badge ${masteryClass}">${masteryText}</span>
            </div>
            <div class="quiz-details">
              <div>Date: ${dateStr}</div>
              <div>Time: ${timeStr}</div>
              <div>Attempts: ${quiz.attempts}</div>
              <div>Score: ${scoreStr}</div>
            </div>
          </div>
        `;
      }).join('');
      
      const resultsHTML = `
        <div class="section">
          <h2>Student Information</h2>
          <div class="names-list">${namesList}</div>
        </div>
        
        <div class="section">
          <h2>Performance Summary</h2>
          <div class="grid">
            <div class="stat-card">
              <div class="stat-value">${totalQuizzes}</div>
              <div class="stat-label">Quizzes Taken</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${totalCorrect}</div>
              <div class="stat-label">Total Correct</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${totalWrong}</div>
              <div class="stat-label">Total Wrong</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${days.size}</div>
              <div class="stat-label">Active Days</div>
            </div>
          </div>
        </div>
        
        <div class="section">
          <h2>Quiz Details</h2>
          ${quizList || '<p>No quiz records found</p>'}
        </div>
        
        <div class="section">
          <h2>Marks Analysis</h2>
          <div class="grid">
            <div class="stat-card">
              <div class="stat-value">${averageMark}</div>
              <div class="stat-label">Average Mark</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${highestMark}</div>
              <div class="stat-label">Highest Mark</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${lowestMark}</div>
              <div class="stat-label">Lowest Mark</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${repeatedMarks.length}</div>
              <div class="stat-label">Repeated Marks</div>
            </div>
          </div>
          ${repeatedMarks.length > 0 ? 
            `<div style="margin-top: 15px;">
              <strong>Repeated Marks:</strong> ${repeatedMarks.join(', ')}
            </div>` : ''}
        </div>
        
        <div class="section">
          <h2>Attempts per Quiz</h2>
          <div class="grid">
            ${Object.entries(attemptsPerQuiz).map(([lesson, attempts]) => `
              <div class="stat-card">
                <div class="stat-value">${attempts}</div>
                <div class="stat-label">Lesson ${parseInt(lesson) + 1}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      showResults(resultsHTML);
    }

    function showResults(html, error = null) {
      const resultsContainer = document.getElementById('results');
      if (error) {
        resultsContainer.innerHTML = `<div class="error">${error}</div>`;
      } else {
        resultsContainer.innerHTML = html;
      }
      resultsContainer.style.display = 'block';
    }

    // Monkey patch localStorage to save report data
    (function() {
      const originalSetItem = localStorage.setItem;
      localStorage.setItem = function(key, value) {
        // When a quiz report is saved, enhance it with analytics data
        if (key.startsWith('quiz_report_')) {
          try {
            const report = JSON.parse(value);
            // Add current timestamp and timeSpent if not present
            if (!report.date) report.date = new Date().toISOString();
            if (!report.timeSpent) {
              // Calculate from start time if available
              const startTime = window.startTime;
              if (startTime) {
                report.timeSpent = Math.floor((Date.now() - startTime) / 1000);
              }
            }
            value = JSON.stringify(report);
          } catch (e) {
            // If not JSON, leave as is
          }
        }
        return originalSetItem.apply(this, arguments);
      };
    })();
  </script>
</body>
</html>
