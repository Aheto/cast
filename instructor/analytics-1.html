<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Quiz Reports</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .nav {
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn:hover, .btn.active {
      background: #0056b3;
    }
    .search-box {
      margin: 20px 0;
      text-align: center;
    }
    #student-search {
      padding: 8px 12px;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }
    #search-btn {
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      margin-left: 10px;
      cursor: pointer;
    }
    #search-btn:hover {
      background: #218838;
    }
    .reports-container {
      display: none;
    }
    .report-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.4;
      overflow-x: auto;
      position: relative;
    }
    .report-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .action-btn {
      padding: 4px 8px;
      font-size: 12px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .action-btn:hover {
      background: #5a6268;
    }
    .error {
      text-align: center;
      color: #dc3545;
      padding: 20px;
      font-weight: bold;
    }
    .note {
      text-align: center;
      color: #6c757d;
      font-size: 0.875rem;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>All Student Quiz Reports (Lessons 2–262)</h1>
      <div class="nav">
        <a href="../index.html" class="btn">Home</a>
        <a href="analytics-1.html" class="btn active">Analytics</a>
      </div>
    </div>

    <div class="search-box">
      <input type="text" id="student-search" placeholder="Enter student name or leave blank for all" />
      <button id="search-btn">Search Reports</button>
    </div>
    <div class="note">Reports are saved only in this browser and tied to your quiz attempts.</div>

    <div id="results" class="reports-container"></div>
  </div>

  <script>
    // Safely override localStorage.setItem to auto-save quiz reports
    (function() {
      const originalSetItem = localStorage.setItem;
      localStorage.setItem = function(key, value) {
        if (typeof value === 'string' && value.includes('*Mini OpenStax —') && value.includes('Student:')) {
          const lessonMatch = value.match(/Lesson (\d+)/);
          if (lessonMatch) {
            const lessonNum = parseInt(lessonMatch[1], 10);
            if (lessonNum >= 2 && lessonNum <= 262) {
              const chapter = lessonNum - 1;
              const reportKey = `saved_report_${chapter}_${Date.now()}`;
              originalSetItem.call(localStorage, reportKey, value);
            }
          }
        }
        return originalSetItem.apply(this, arguments);
      };
    })();

    // Helper: download a blob as file
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Helper: share file (Web Share API fallback to download)
    async function shareOrDownload(blob, filename, title = 'Quiz Report') {
      if (navigator.share && navigator.canShare) {
        const file = new File([blob], filename, { type: blob.type });
        if (navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({
              title,
              files: [file],
            });
            return;
          } catch (err) {
            if (err.name !== 'AbortError') console.warn('Share failed:', err);
          }
        }
      }
      // Fallback: download
      downloadBlob(blob, filename);
    }

    // Generate SVG from plain text report
    function generateSVG(text, width = 800, lineHeight = 16, padding = 20) {
      const lines = text.split('\n');
      const height = lines.length * lineHeight + padding * 2;
      const fontSize = 13;
      const fontFamily = 'monospace';

      // Escape text for SVG
      const escapedLines = lines.map(line =>
        line
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
      );

      const tspans = escapedLines
        .map((line, i) => `<tspan x="${padding}" dy="${i === 0 ? lineHeight : lineHeight}">${line}</tspan>`)
        .join('');

      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
  <style>
    .report-text { font-family: ${fontFamily}; font-size: ${fontSize}px; }
  </style>
  <rect width="100%" height="100%" fill="white" stroke="#ccc" stroke-width="1"/>
  <text x="0" y="${padding}" class="report-text">
    ${tspans}
  </text>
</svg>`;

      return svg;
    }

    // Convert SVG string to PNG Blob
    function svgToPngBlob(svgString, width = 800, height = null) {
      return new Promise((resolve, reject) => {
        const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const svgUrl = URL.createObjectURL(svgBlob);

        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height || canvas.width * 0.7; // fallback
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
          URL.revokeObjectURL(svgUrl);

          canvas.toBlob(
            blob => {
              if (blob) resolve(blob);
              else reject(new Error('Canvas toBlob failed'));
            },
            'image/png',
            1.0
          );
        };
        img.onerror = () => {
          URL.revokeObjectURL(svgUrl);
          reject(new Error('Failed to load SVG image'));
        };
        img.src = svgUrl;
      });
    }

    function renderReportCard(reportText, timestamp) {
      // Escape for safe display in HTML
      const safeHTML = reportText
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>');

      const card = document.createElement('div');
      card.className = 'report-card';
      card.innerHTML = `
        <div>${safeHTML}</div>
        <div class="report-actions">
          <button class="action-btn download-svg">Download SVG</button>
          <button class="action-btn download-png">Download PNG</button>
          <button class="action-btn share-svg">Share SVG</button>
          <button class="action-btn share-png">Share PNG</button>
        </div>
      `;

      // Extract filename base
      const studentMatch = reportText.match(/Student:\s*(.+)\n/);
      const lessonMatch = reportText.match(/Lesson (\d+)/);
      const studentName = (studentMatch ? studentMatch[1].trim() : 'Student').replace(/[^a-z0-9]/gi, '_');
      const lessonNum = lessonMatch ? lessonMatch[1] : 'X';
      const dateStr = new Date(timestamp).toISOString().slice(0, 10); // YYYY-MM-DD
      const baseName = `QuizReport_Lesson${lessonNum}_${studentName}_${dateStr}`;

      // Add event listeners
      card.querySelector('.download-svg').addEventListener('click', () => {
        const svgStr = generateSVG(reportText);
        const blob = new Blob([svgStr], { type: 'image/svg+xml' });
        downloadBlob(blob, `${baseName}.svg`);
      });

      card.querySelector('.download-png').addEventListener('click', async () => {
        try {
          const svgStr = generateSVG(reportText);
          const pngBlob = await svgToPngBlob(svgStr);
          downloadBlob(pngBlob, `${baseName}.png`);
        } catch (err) {
          alert('Failed to generate PNG: ' + err.message);
        }
      });

      card.querySelector('.share-svg').addEventListener('click', () => {
        const svgStr = generateSVG(reportText);
        const blob = new Blob([svgStr], { type: 'image/svg+xml' });
        shareOrDownload(blob, `${baseName}.svg`, 'Quiz Report (SVG)');
      });

      card.querySelector('.share-png').addEventListener('click', async () => {
        try {
          const svgStr = generateSVG(reportText);
          const pngBlob = await svgToPngBlob(svgStr);
          shareOrDownload(pngBlob, `${baseName}.png`, 'Quiz Report (PNG)');
        } catch (err) {
          alert('Failed to generate/share PNG: ' + err.message);
        }
      });

      return card;
    }

    function showReports() {
      const searchTerm = document.getElementById('student-search').value.trim().toLowerCase();
      const allKeys = Object.keys(localStorage);
      const reportEntries = [];

      for (const key of allKeys) {
        if (key.startsWith('saved_report_')) {
          const reportText = localStorage.getItem(key);
          if (reportText && typeof reportText === 'string') {
            const studentMatch = reportText.match(/Student:\s*(.+)\n/);
            const studentName = studentMatch ? studentMatch[1].trim() : '[Unknown]';
            if (!searchTerm || studentName.toLowerCase().includes(searchTerm)) {
              const parts = key.split('_');
              const timestamp = parts.length >= 4 ? parseInt(parts[parts.length - 1], 10) : 0;
              reportEntries.push({ text: reportText, time: timestamp });
            }
          }
        }
      }

      reportEntries.sort((a, b) => b.time - a.time);

      const container = document.getElementById('results');

      if (reportEntries.length === 0) {
        container.innerHTML = `<div class="error">No quiz reports found${searchTerm ? ` for "${searchTerm}"` : ''}.</div>`;
        container.style.display = 'block';
        return;
      }

      const fragment = document.createDocumentFragment();
      const heading = document.createElement('h2');
      heading.textContent = `${reportEntries.length} Report(s) Found`;
      fragment.appendChild(heading);

      reportEntries.forEach(entry => {
        const card = renderReportCard(entry.text, entry.time);
        fragment.appendChild(card);
      });

      container.innerHTML = '';
      container.appendChild(fragment);
      container.style.display = 'block';
    }

    document.getElementById('search-btn').addEventListener('click', showReports);
    document.getElementById('student-search').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') showReports();
    });

    window.addEventListener('DOMContentLoaded', showReports);
  </script>
</body>
</html>
